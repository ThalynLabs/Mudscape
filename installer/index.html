<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mudscape Installer</title>
  <style>
    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --primary: #0f3460;
      --accent: #e94560;
      --text: #eee;
      --text-secondary: #aaa;
      --success: #4ade80;
      --border: #2a2a4a;
      --warning: #fbbf24;
    }
    
    * { box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .container {
      max-width: 750px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    h1 {
      color: var(--accent);
      margin-bottom: 10px;
      font-size: 2.5rem;
    }
    
    .subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }
    
    .step {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
    }
    
    .step.active { display: block; }
    
    .step-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .step-number {
      background: var(--accent);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .step-title {
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .step-content {
      margin-bottom: 25px;
    }
    
    .step-content p { margin: 0 0 15px 0; }
    
    .code-block {
      background: #0d1117;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.95rem;
      overflow-x: auto;
      position: relative;
      margin: 15px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .code-block code { color: #7ee787; }
    
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .copy-btn:hover { background: var(--accent); }
    .copy-btn.copied { background: var(--success); }
    
    .buttons {
      display: flex;
      gap: 15px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-primary:hover { filter: brightness(1.1); }
    
    .btn-secondary {
      background: var(--primary);
      color: white;
    }
    
    .btn-secondary:hover { filter: brightness(1.2); }
    
    .btn-success {
      background: var(--success);
      color: #000;
    }
    
    .btn-success:hover { filter: brightness(1.1); }
    
    .btn-primary:disabled, .btn-success:disabled {
      background: #555;
      cursor: not-allowed;
    }
    
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
      margin: 8px 0 15px 0;
    }
    
    input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    input:read-only {
      background: #0d1117;
      color: #7ee787;
      font-family: monospace;
    }
    
    label {
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .input-group {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    
    .input-group input {
      flex: 1;
    }
    
    .input-group button {
      margin-top: 8px;
      padding: 12px 20px;
      white-space: nowrap;
    }
    
    .info-box {
      background: rgba(233, 69, 96, 0.1);
      border-left: 4px solid var(--accent);
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin: 15px 0;
    }
    
    .success-box {
      background: rgba(74, 222, 128, 0.1);
      border-left: 4px solid var(--success);
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin: 15px 0;
    }
    
    .warning-box {
      background: rgba(251, 191, 36, 0.1);
      border-left: 4px solid var(--warning);
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin: 15px 0;
    }
    
    .progress-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--border);
      transition: background 0.3s;
    }
    
    .progress-dot.active { background: var(--accent); }
    .progress-dot.completed { background: var(--success); }
    
    .os-buttons {
      display: flex;
      gap: 15px;
      margin: 20px 0;
    }
    
    .os-btn {
      flex: 1;
      padding: 20px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .os-btn:hover { border-color: var(--accent); }
    
    .os-btn.selected {
      border-color: var(--accent);
      background: rgba(233, 69, 96, 0.1);
    }
    
    .os-btn .icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .help-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }
    
    .hidden { display: none !important; }
    
    .inline-code {
      background: #0d1117;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: monospace;
      color: #7ee787;
    }

    .mode-option {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-option:hover { border-color: var(--accent); }

    .mode-option.selected {
      border-color: var(--accent);
      background: rgba(233, 69, 96, 0.1);
    }

    .mode-option h3 {
      margin: 0 0 8px 0;
      color: var(--text);
    }

    .mode-option p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .download-section {
      background: var(--bg);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
    }

    .download-section h3 {
      margin: 0 0 15px 0;
      color: var(--text);
    }

    .download-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .file-list {
      text-align: left;
      margin: 20px 0;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg);
      border-radius: 8px;
      margin: 8px 0;
    }

    .file-item .icon { font-size: 1.5rem; }
    .file-item .name { flex: 1; font-family: monospace; }
    
    .file-item .status {
      color: var(--success);
      font-size: 0.9rem;
    }

    .final-step h2 {
      color: var(--success);
      text-align: center;
    }

    .checklist {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }

    .checklist li {
      padding: 12px 15px;
      background: var(--bg);
      border-radius: 8px;
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .checklist li::before {
      content: "‚úì";
      color: var(--success);
      font-weight: bold;
      font-size: 1.2rem;
    }

    @media (max-width: 600px) {
      .os-buttons, .buttons, .download-buttons { flex-direction: column; }
      button { width: 100%; }
      .input-group { flex-direction: column; }
      .input-group button { width: 100%; margin-top: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Mudscape Installer</h1>
      <p class="subtitle">Accessible MUD Client - Setup Wizard</p>
    </header>

    <div class="progress-bar" id="progressBar"></div>

    <!-- Step 0: Welcome & OS Selection -->
    <div class="step active" id="step-0">
      <div class="step-header">
        <div class="step-number">1</div>
        <div class="step-title">Welcome</div>
      </div>
      <div class="step-content">
        <p>This wizard will create all the configuration files you need to run Mudscape. Just fill in the information and download the generated files.</p>
        
        <p><strong>What operating system are you using?</strong></p>
        
        <div class="os-buttons">
          <button class="os-btn" data-os="mac" onclick="selectOS('mac')">
            <div class="icon">üçé</div>
            <div>Mac</div>
          </button>
          <button class="os-btn" data-os="windows" onclick="selectOS('windows')">
            <div class="icon">ü™ü</div>
            <div>Windows</div>
          </button>
          <button class="os-btn" data-os="linux" onclick="selectOS('linux')">
            <div class="icon">üêß</div>
            <div>Linux</div>
          </button>
        </div>
      </div>
      <div class="buttons">
        <div></div>
        <button class="btn-primary" onclick="nextStep()" id="welcomeNext" disabled>Next Step</button>
      </div>
    </div>

    <!-- Step 1: Account Mode -->
    <div class="step" id="step-1">
      <div class="step-header">
        <div class="step-number">2</div>
        <div class="step-title">Choose Account Mode</div>
      </div>
      <div class="step-content">
        <p>How do you want to use Mudscape?</p>
        
        <div class="mode-option" onclick="selectMode('single')" id="mode-single">
          <h3>Single-User Mode (Recommended for Personal Use)</h3>
          <p>No login required. Perfect if you're the only one using this installation on your computer.</p>
        </div>

        <div class="mode-option" onclick="selectMode('multi')" id="mode-multi">
          <h3>Multi-User Mode</h3>
          <p>Requires username and password to log in. Use this if multiple people will access Mudscape, or if you're hosting it on a server.</p>
        </div>

        <div id="adminSetup" class="hidden" style="margin-top: 20px;">
          <div class="info-box">
            <strong>Create your admin account:</strong>
          </div>
          
          <label for="adminUser">Admin Username</label>
          <input type="text" id="adminUser" placeholder="Enter your username" value="admin">
          
          <label for="adminPass">Admin Password</label>
          <div class="input-group">
            <input type="text" id="adminPass" placeholder="Enter a password">
            <button class="btn-secondary" onclick="generatePassword()">Generate</button>
          </div>
          <p class="help-text">Write this password down somewhere safe!</p>
        </div>
      </div>
      <div class="buttons">
        <button class="btn-secondary" onclick="prevStep()">Back</button>
        <button class="btn-primary" onclick="nextStep()" id="modeNext" disabled>Next Step</button>
      </div>
    </div>

    <!-- Step 2: Database Configuration -->
    <div class="step" id="step-2">
      <div class="step-header">
        <div class="step-number">3</div>
        <div class="step-title">Database Settings</div>
      </div>
      <div class="step-content">
        <p>Configure your PostgreSQL database connection. If you haven't installed PostgreSQL yet, you can use the default values and install it later.</p>

        <label for="dbHost">Database Host</label>
        <input type="text" id="dbHost" value="localhost">
        <p class="help-text">Usually "localhost" for local installations</p>

        <label for="dbPort">Database Port</label>
        <input type="number" id="dbPort" value="5432">
        <p class="help-text">Default PostgreSQL port is 5432</p>

        <label for="dbUser">Database Username</label>
        <input type="text" id="dbUser" placeholder="Your database username" id="dbUserField">
        <p class="help-text" id="dbUserHelp">On Mac/Linux, often your computer username. On Windows, usually "postgres".</p>

        <label for="dbPassword">Database Password</label>
        <input type="text" id="dbPassword" placeholder="Leave blank if none set">
        <p class="help-text">The password for your PostgreSQL user</p>

        <label for="dbName">Database Name</label>
        <input type="text" id="dbName" value="mudscape">
        <p class="help-text">Name of the database to create for Mudscape</p>
      </div>
      <div class="buttons">
        <button class="btn-secondary" onclick="prevStep()">Back</button>
        <button class="btn-primary" onclick="nextStep()">Next Step</button>
      </div>
    </div>

    <!-- Step 3: Application Settings -->
    <div class="step" id="step-3">
      <div class="step-header">
        <div class="step-number">4</div>
        <div class="step-title">Application Settings</div>
      </div>
      <div class="step-content">
        <label for="appPort">Mudscape Port</label>
        <input type="number" id="appPort" value="5000">
        <p class="help-text">The port Mudscape will run on. Access it at http://localhost:5000</p>

        <label for="sessionSecret">Session Secret (Security Key)</label>
        <div class="input-group">
          <input type="text" id="sessionSecret" readonly placeholder="Click Generate to create">
          <button class="btn-success" onclick="generateSessionSecret()">Generate</button>
        </div>
        <p class="help-text">A random string used to secure your sessions. Click Generate to create one.</p>

        <div class="info-box" id="secretWarning" style="display: none;">
          <strong>Important:</strong> Please generate a session secret before continuing.
        </div>
      </div>
      <div class="buttons">
        <button class="btn-secondary" onclick="prevStep()">Back</button>
        <button class="btn-primary" onclick="validateAndContinue()" id="settingsNext">Next Step</button>
      </div>
    </div>

    <!-- Step 4: Generate & Download Files -->
    <div class="step" id="step-4">
      <div class="step-header">
        <div class="step-number">5</div>
        <div class="step-title">Download Your Files</div>
      </div>
      <div class="step-content">
        <p>Your configuration is ready! Download these files to set up Mudscape:</p>

        <div class="download-section">
          <h3>Configuration File</h3>
          <p>This file contains your database connection and settings.</p>
          <button class="btn-success" onclick="downloadEnvFile()">.env File</button>
        </div>

        <div class="download-section">
          <h3>Setup Script</h3>
          <p>This script will install everything automatically. Just run it!</p>
          <button class="btn-success" onclick="downloadSetupScript()" id="downloadScriptBtn">Download Setup Script</button>
        </div>

        <div class="file-list" id="downloadedFiles" style="display: none;">
          <h4>Downloaded Files:</h4>
          <div id="fileListContent"></div>
        </div>

        <div class="success-box">
          <strong>What's in the setup script?</strong>
          <ul style="margin: 10px 0 0 0; padding-left: 20px;">
            <li>Checks if Node.js and PostgreSQL are installed</li>
            <li>Downloads Mudscape from GitHub</li>
            <li>Installs all dependencies</li>
            <li>Creates the database</li>
            <li>Sets up the database tables</li>
            <li>Starts Mudscape</li>
          </ul>
        </div>
      </div>
      <div class="buttons">
        <button class="btn-secondary" onclick="prevStep()">Back</button>
        <button class="btn-primary" onclick="nextStep()">Next Step</button>
      </div>
    </div>

    <!-- Step 5: Run Setup -->
    <div class="step" id="step-5">
      <div class="step-header">
        <div class="step-number">6</div>
        <div class="step-title">Run the Setup</div>
      </div>
      <div class="step-content">
        <p><strong>Open your <span class="terminal-name">Terminal</span>:</strong></p>
        <div id="openTerminalInstructions"></div>

        <p><strong>Navigate to where you downloaded the files:</strong></p>
        <div class="code-block">
          <code id="cdDownloads">cd ~/Downloads</code>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>

        <p><strong>Make the script executable and run it:</strong></p>
        <div class="code-block" id="runScriptBlock">
          <code id="runScriptCmd">chmod +x mudscape-setup.sh && ./mudscape-setup.sh</code>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>

        <div class="info-box">
          <strong>The script will:</strong>
          <ol style="margin: 10px 0 0 0; padding-left: 20px;">
            <li>Check your system for required software</li>
            <li>Download Mudscape</li>
            <li>Install dependencies</li>
            <li>Set up the database</li>
            <li>Copy your .env file</li>
            <li>Start Mudscape!</li>
          </ol>
          <p style="margin-top: 10px;">Just follow any prompts that appear.</p>
        </div>

        <div class="warning-box" id="windowsNote" style="display: none;">
          <strong>Windows Users:</strong> Right-click on <span class="inline-code">mudscape-setup.bat</span> and select "Run as administrator".
        </div>
      </div>
      <div class="buttons">
        <button class="btn-secondary" onclick="prevStep()">Back</button>
        <button class="btn-primary" onclick="nextStep()">I've Run the Script</button>
      </div>
    </div>

    <!-- Step 6: Complete -->
    <div class="step" id="step-6">
      <div class="step-header">
        <div class="step-number">7</div>
        <div class="step-title">Setup Complete!</div>
      </div>
      <div class="step-content final-step">
        <h2>Congratulations!</h2>
        
        <p>Mudscape should now be running. Open your browser and go to:</p>
        
        <div class="code-block" style="text-align: center; font-size: 1.2rem;">
          <code id="finalUrl">http://localhost:5000</code>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>

        <ul class="checklist">
          <li>Mudscape is installed</li>
          <li>Database is configured</li>
          <li>Your settings are saved</li>
          <li id="modeConfirm">Running in single-user mode</li>
        </ul>

        <div class="warning-box">
          <strong>Security Reminder:</strong> Please delete this installer file (<span class="inline-code">index.html</span>) now. It contains your configuration details and should not be kept.
        </div>

        <div class="info-box">
          <strong>To start Mudscape in the future:</strong>
          <ol style="margin: 10px 0 0 0; padding-left: 20px;">
            <li>Open <span class="terminal-name">Terminal</span></li>
            <li>Go to the mudscape folder: <span class="inline-code" id="futureCD">cd ~/Documents/mudscape</span></li>
            <li>Run: <span class="inline-code">npm run dev</span></li>
          </ol>
        </div>

        <div class="success-box">
          <strong>Need help?</strong> Press F1 in Mudscape to open the Help Wiki, or type <span class="inline-code">/help</span> in the terminal.
        </div>
      </div>
      <div class="buttons">
        <button class="btn-secondary" onclick="prevStep()">Back</button>
        <button class="btn-primary" onclick="window.print()">Print These Instructions</button>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 0;
    const totalSteps = 7;
    let selectedOS = null;
    let accountMode = null;
    let downloadedFiles = [];

    document.addEventListener('DOMContentLoaded', () => {
      updateProgressBar();
    });

    function updateProgressBar() {
      const bar = document.getElementById('progressBar');
      bar.innerHTML = '';
      for (let i = 0; i < totalSteps; i++) {
        const dot = document.createElement('div');
        dot.className = 'progress-dot';
        if (i < currentStep) dot.classList.add('completed');
        if (i === currentStep) dot.classList.add('active');
        bar.appendChild(dot);
      }
    }

    function showStep(stepNum) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step-${stepNum}`).classList.add('active');
      currentStep = stepNum;
      updateProgressBar();
      window.scrollTo(0, 0);
    }

    function nextStep() {
      if (currentStep < totalSteps - 1) {
        showStep(currentStep + 1);
      }
    }

    function prevStep() {
      if (currentStep > 0) {
        showStep(currentStep - 1);
      }
    }

    function selectOS(os) {
      selectedOS = os;
      document.querySelectorAll('.os-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelector(`[data-os="${os}"]`).classList.add('selected');
      document.getElementById('welcomeNext').disabled = false;
      updateOSSpecificContent();
    }

    function updateOSSpecificContent() {
      const terminalNames = document.querySelectorAll('.terminal-name');
      const openInstructions = document.getElementById('openTerminalInstructions');
      const cdDownloads = document.getElementById('cdDownloads');
      const runScriptCmd = document.getElementById('runScriptCmd');
      const windowsNote = document.getElementById('windowsNote');
      const downloadScriptBtn = document.getElementById('downloadScriptBtn');
      const dbUserHelp = document.getElementById('dbUserHelp');
      const futureCD = document.getElementById('futureCD');

      if (selectedOS === 'mac') {
        terminalNames.forEach(el => el.textContent = 'Terminal');
        openInstructions.innerHTML = `
          <ul>
            <li>Press <span class="inline-code">Cmd + Space</span> to open Spotlight</li>
            <li>Type "Terminal" and press Enter</li>
          </ul>
        `;
        cdDownloads.textContent = 'cd ~/Downloads';
        runScriptCmd.textContent = 'chmod +x mudscape-setup.sh && ./mudscape-setup.sh';
        windowsNote.style.display = 'none';
        downloadScriptBtn.textContent = 'Download Setup Script (.sh)';
        dbUserHelp.textContent = 'Usually your Mac username. Run "whoami" in Terminal to check.';
        futureCD.textContent = 'cd ~/Documents/mudscape';
      } else if (selectedOS === 'windows') {
        terminalNames.forEach(el => el.textContent = 'PowerShell');
        openInstructions.innerHTML = `
          <ul>
            <li>Press the <span class="inline-code">Windows key</span></li>
            <li>Type "PowerShell" and click "Windows PowerShell"</li>
            <li>Or right-click the Start button and select "Windows Terminal"</li>
          </ul>
        `;
        cdDownloads.textContent = 'cd $HOME\\Downloads';
        runScriptCmd.textContent = '.\\mudscape-setup.bat';
        windowsNote.style.display = 'block';
        downloadScriptBtn.textContent = 'Download Setup Script (.bat)';
        dbUserHelp.textContent = 'Default PostgreSQL username is usually "postgres".';
        futureCD.textContent = 'cd $HOME\\Documents\\mudscape';
      } else if (selectedOS === 'linux') {
        terminalNames.forEach(el => el.textContent = 'Terminal');
        openInstructions.innerHTML = `
          <ul>
            <li>Press <span class="inline-code">Ctrl + Alt + T</span></li>
            <li>Or search for "Terminal" in your applications menu</li>
          </ul>
        `;
        cdDownloads.textContent = 'cd ~/Downloads';
        runScriptCmd.textContent = 'chmod +x mudscape-setup.sh && ./mudscape-setup.sh';
        windowsNote.style.display = 'none';
        downloadScriptBtn.textContent = 'Download Setup Script (.sh)';
        dbUserHelp.textContent = 'Usually your Linux username. Run "whoami" in Terminal to check.';
        futureCD.textContent = 'cd ~/Documents/mudscape';
      }
    }

    function selectMode(mode) {
      accountMode = mode;
      document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('selected'));
      document.getElementById(`mode-${mode}`).classList.add('selected');
      document.getElementById('adminSetup').classList.toggle('hidden', mode !== 'multi');
      document.getElementById('modeNext').disabled = false;
      
      // Update final step text
      document.getElementById('modeConfirm').textContent = 
        mode === 'single' ? 'Running in single-user mode (no login required)' : 'Running in multi-user mode with admin account';
    }

    function generateRandomString(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      const array = new Uint32Array(length);
      crypto.getRandomValues(array);
      for (let i = 0; i < length; i++) {
        result += chars[array[i] % chars.length];
      }
      return result;
    }

    function generatePassword() {
      document.getElementById('adminPass').value = generateRandomString(16);
    }

    function generateSessionSecret() {
      document.getElementById('sessionSecret').value = generateRandomString(64);
      document.getElementById('secretWarning').style.display = 'none';
    }

    function validateAndContinue() {
      const secret = document.getElementById('sessionSecret').value;
      if (!secret) {
        document.getElementById('secretWarning').style.display = 'block';
        return;
      }
      nextStep();
    }

    function getConfig() {
      const host = document.getElementById('dbHost').value || 'localhost';
      const port = document.getElementById('dbPort').value || '5432';
      const user = document.getElementById('dbUser').value || 'postgres';
      const password = document.getElementById('dbPassword').value;
      const dbName = document.getElementById('dbName').value || 'mudscape';
      const appPort = document.getElementById('appPort').value || '5000';
      const sessionSecret = document.getElementById('sessionSecret').value;
      const adminUser = document.getElementById('adminUser').value || 'admin';
      const adminPass = document.getElementById('adminPass').value;

      const pwPart = password ? `:${encodeURIComponent(password)}` : '';
      const dbUrl = `postgresql://${user}${pwPart}@${host}:${port}/${dbName}`;

      return { host, port, user, password, dbName, appPort, sessionSecret, dbUrl, adminUser, adminPass };
    }

    function generateEnvContent() {
      const config = getConfig();
      let content = `# Mudscape Configuration
# Generated by Mudscape Installer

DATABASE_URL=${config.dbUrl}
SESSION_SECRET=${config.sessionSecret}
PORT=${config.appPort}
`;

      if (accountMode === 'single') {
        content += `SINGLE_USER_MODE=true\n`;
      }

      return content;
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Track downloaded files
      if (!downloadedFiles.includes(filename)) {
        downloadedFiles.push(filename);
        updateDownloadedFilesList();
      }
    }

    function updateDownloadedFilesList() {
      const container = document.getElementById('downloadedFiles');
      const content = document.getElementById('fileListContent');
      
      if (downloadedFiles.length > 0) {
        container.style.display = 'block';
        content.innerHTML = downloadedFiles.map(f => `
          <div class="file-item">
            <span class="icon">üìÑ</span>
            <span class="name">${f}</span>
            <span class="status">‚úì Downloaded</span>
          </div>
        `).join('');
      }
    }

    function downloadEnvFile() {
      downloadFile('.env', generateEnvContent());
    }

    function generateUnixScript() {
      const config = getConfig();
      const repoUrl = 'https://github.com/YOUR_USERNAME/mudscape.git';
      
      let script = `#!/bin/bash
# Mudscape Setup Script
# Generated by Mudscape Installer

set -e

echo "========================================"
echo "   Mudscape Setup Script"
echo "========================================"
echo ""

# Colors for output
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
NC='\\033[0m' # No Color

# Check for Node.js
echo "Checking for Node.js..."
if ! command -v node &> /dev/null; then
    echo -e "\${RED}Node.js is not installed.\${NC}"
    echo "Please install Node.js from https://nodejs.org"
    echo "Then run this script again."
    exit 1
fi
echo -e "\${GREEN}‚úì Node.js found: $(node --version)\${NC}"

# Check for PostgreSQL
echo "Checking for PostgreSQL..."
if ! command -v psql &> /dev/null; then
    echo -e "\${YELLOW}Warning: PostgreSQL command-line tools not found.\${NC}"
    echo "Make sure PostgreSQL is installed and running."
fi

# Check for Git
echo "Checking for Git..."
if ! command -v git &> /dev/null; then
    echo -e "\${RED}Git is not installed.\${NC}"
    echo "Please install Git first."
    exit 1
fi
echo -e "\${GREEN}‚úì Git found\${NC}"

echo ""
echo "Creating installation directory..."
INSTALL_DIR="$HOME/Documents/mudscape"
mkdir -p "$HOME/Documents"

# Clone or update repository
if [ -d "$INSTALL_DIR" ]; then
    echo "Mudscape folder already exists. Updating..."
    cd "$INSTALL_DIR"
    git pull origin main || git pull origin master || echo "Could not update, continuing with existing files..."
else
    echo "Downloading Mudscape..."
    cd "$HOME/Documents"
    git clone ${repoUrl} mudscape || {
        echo -e "\${RED}Failed to download Mudscape.\${NC}"
        echo "Please check your internet connection and try again."
        exit 1
    }
fi

cd "$INSTALL_DIR"
echo -e "\${GREEN}‚úì Mudscape downloaded to $INSTALL_DIR\${NC}"

# Copy .env file
echo ""
echo "Setting up configuration..."
ENV_FILE="$HOME/Downloads/.env"
if [ -f "$ENV_FILE" ]; then
    cp "$ENV_FILE" "$INSTALL_DIR/.env"
    echo -e "\${GREEN}‚úì Configuration copied\${NC}"
else
    echo -e "\${YELLOW}Warning: .env file not found in Downloads folder.\${NC}"
    echo "Please copy the .env file to $INSTALL_DIR manually."
fi

# Install dependencies
echo ""
echo "Installing dependencies (this may take a few minutes)..."
npm install
echo -e "\${GREEN}‚úì Dependencies installed\${NC}"

# Create database
echo ""
echo "Setting up database..."
createdb ${config.dbName} 2>/dev/null || echo "Database may already exist, continuing..."

# Run database migrations
echo "Initializing database tables..."
npm run db:push
echo -e "\${GREEN}‚úì Database ready\${NC}"

`;

      if (accountMode === 'multi' && config.adminUser && config.adminPass) {
        script += `
# Create admin user (will be done on first access via setup wizard)
echo ""
echo -e "\${YELLOW}Note: Log in with your admin credentials after startup.\${NC}"
echo "Username: ${config.adminUser}"
`;
      }

      script += `
echo ""
echo "========================================"
echo -e "\${GREEN}   Setup Complete!\${NC}"
echo "========================================"
echo ""
echo "Starting Mudscape..."
echo "Open your browser to: http://localhost:${config.appPort}"
echo ""
echo "Press Ctrl+C to stop the server."
echo ""

npm run dev
`;

      return script;
    }

    function generateWindowsScript() {
      const config = getConfig();
      const repoUrl = 'https://github.com/YOUR_USERNAME/mudscape.git';

      return `@echo off
REM Mudscape Setup Script for Windows
REM Generated by Mudscape Installer

echo ========================================
echo    Mudscape Setup Script
echo ========================================
echo.

REM Check for Node.js
echo Checking for Node.js...
where node >nul 2>nul
if %ERRORLEVEL% NEQ 0 (
    echo [ERROR] Node.js is not installed.
    echo Please install Node.js from https://nodejs.org
    echo Then run this script again.
    pause
    exit /b 1
)
for /f "tokens=*" %%i in ('node --version') do echo [OK] Node.js found: %%i

REM Check for Git
echo Checking for Git...
where git >nul 2>nul
if %ERRORLEVEL% NEQ 0 (
    echo [ERROR] Git is not installed.
    echo Please install Git from https://git-scm.com
    pause
    exit /b 1
)
echo [OK] Git found

echo.
echo Creating installation directory...
set INSTALL_DIR=%USERPROFILE%\\Documents\\mudscape

if exist "%INSTALL_DIR%" (
    echo Mudscape folder already exists. Updating...
    cd /d "%INSTALL_DIR%"
    git pull origin main || git pull origin master || echo Could not update, continuing...
) else (
    echo Downloading Mudscape...
    cd /d "%USERPROFILE%\\Documents"
    git clone ${repoUrl} mudscape
    if %ERRORLEVEL% NEQ 0 (
        echo [ERROR] Failed to download Mudscape.
        pause
        exit /b 1
    )
)

cd /d "%INSTALL_DIR%"
echo [OK] Mudscape downloaded to %INSTALL_DIR%

REM Copy .env file
echo.
echo Setting up configuration...
if exist "%USERPROFILE%\\Downloads\\.env" (
    copy "%USERPROFILE%\\Downloads\\.env" "%INSTALL_DIR%\\.env" >nul
    echo [OK] Configuration copied
) else (
    echo [WARNING] .env file not found in Downloads folder.
    echo Please copy the .env file to %INSTALL_DIR% manually.
)

REM Install dependencies
echo.
echo Installing dependencies (this may take a few minutes)...
call npm install
echo [OK] Dependencies installed

REM Create database
echo.
echo Setting up database...
createdb ${config.dbName} 2>nul || echo Database may already exist, continuing...

REM Run database migrations
echo Initializing database tables...
call npm run db:push
echo [OK] Database ready

echo.
echo ========================================
echo    Setup Complete!
echo ========================================
echo.
echo Starting Mudscape...
echo Open your browser to: http://localhost:${config.appPort}
echo.
echo Press Ctrl+C to stop the server.
echo.

call npm run dev
`;
    }

    function downloadSetupScript() {
      if (selectedOS === 'windows') {
        downloadFile('mudscape-setup.bat', generateWindowsScript());
      } else {
        downloadFile('mudscape-setup.sh', generateUnixScript());
      }
      
      // Update final URL
      const config = getConfig();
      document.getElementById('finalUrl').textContent = `http://localhost:${config.appPort}`;
    }

    function copyCode(button) {
      const codeBlock = button.parentElement;
      const code = codeBlock.querySelector('code').textContent;
      
      navigator.clipboard.writeText(code).then(() => {
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      });
    }
  </script>
</body>
</html>
